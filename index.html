<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>25-Min HIIT Timer — Sacha Protocol</title>
<meta name="theme-color" content="#0f172a"/>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png">
<style>
  :root{--bg:#0f172a;--fg:#e5e7eb;--acc:#22c55e;--rest:#f59e0b;--muted:#94a3b8;--card:#111827;--bad:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,#0b1023,#111827);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  h1{font-size:1.4rem;margin:10px 0 6px}
  .card{background:rgba(17,24,39,.7);backdrop-filter:blur(6px);border:1px solid #1f2937;padding:16px;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .rows{display:grid;gap:12px}
  .big{font-size:3.4rem;line-height:1.1;margin:6px 0 0;font-variant-numeric:tabular-nums}
  .sub{color:var(--muted);margin-top:2px}
  .phase{font-weight:700;letter-spacing:.3px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{appearance:none;border:none;border-radius:14px;padding:12px 14px;font-weight:700}
  .primary{background:var(--acc);color:#0b1325}
  .ghost{background:#0b1325;color:#e5e7eb;border:1px solid #1f2937}
  .danger{background:var(--bad);color:white}
  .bar{height:12px;background:#0b1325;border-radius:12px;overflow:hidden;border:1px solid #1f2937}
  .fill{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a)}
  .fill.rest{background:linear-gradient(90deg,#f59e0b,#d97706)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .tog{display:flex;align-items:center;gap:8px}
  ul{margin:8px 0 0;padding-left:18px}
  li{margin:4px 0}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;}
  .hint{font-size:.92rem;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap rows">
    <div class="card rows">
      <h1>25-Minute HIIT Timer — <span class="phase" id="phase">Ready</span></h1>
      <div class="big mono" id="clock">25:00</div>
      <div class="sub" id="label">Tap START. Flow: 5′ Warm-up → 15′ HIIT (30/15 × 20) → 5′ Core finisher.</div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="bar"><div class="fill" id="segFill"></div></div>
          <div class="hint" id="segHint">Segment 0/0</div>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <div class="bar"><div class="fill" id="totFill"></div></div>
          <div class="hint" id="totHint">Total 0%</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:8px">
        <button id="startBtn" class="primary">▶ Start</button>
        <button id="pauseBtn" class="ghost">⏸ Pause</button>
        <button id="resetBtn" class="danger">⟲ Reset</button>
        <button id="skipBtn" class="ghost">⏭ Next</button>
      </div>

      <div class="row" style="margin-top:8px;gap:14px;flex-wrap:wrap">
        <label class="tog"><input type="checkbox" id="voiceTg" checked /> Voice</label>
        <label class="tog"><input type="checkbox" id="beepTg" checked /> 3‑2‑1 Beeps</label>
        <label class="tog"><input type="checkbox" id="vibrateTg" checked /> Vibrate</label>
        <label class="tog"><input type="checkbox" id="wakelockTg" checked /> Keep screen on</label>
        <label class="tog"><input type="checkbox" id="nextCueTg" checked /> Announce next exercise</label>
        <label class="tog"><input type="checkbox" id="detailWarmCoreTg" checked /> Detailed warm‑up & core cues</label>
      </div>
    </div>

    <div class="card rows">
      <strong>Program</strong>
      <ul id="programList"></ul>
      <div class="hint">Install: Chrome → ⋮ → Install app / Add to Home screen. Works offline.</div>
    </div>
  </div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}

(function(){
  const exercises = ["Burpees","Push-ups","Air squats","Mountain climbers","Plank shoulder taps"];
  const segments = [];
  segments.push({type:"warmup", label:"Warm-up", sub:"Mobility + easy jumps", dur:300});
  for(let round=1; round<=4; round++){
    for(let i=0;i<exercises.length;i++){
      const ex = exercises[i];
      segments.push({type:"work", label:`HIIT — Round ${round}/4`, sub:ex, dur:30});
      segments.push({type:"rest", label:`Rest`, sub:"", dur:15, next: exercises[(i+1)%exercises.length]});
    }
  }
  const fin = [
    {type:"work", label:"Core — X-ups", sub:"30 s", dur:30},
    {type:"rest", label:"Rest", sub:"", dur:15, next:"Hollow hold"},
    {type:"work", label:"Core — Hollow hold", sub:"30 s", dur:30},
    {type:"rest", label:"Rest", sub:"", dur:15, next:"Plank"},
    {type:"work", label:"Core — Plank", sub:"45 s", dur:45},
    {type:"rest", label:"Rest", sub:"", dur:15, next:"X-ups"},
  ];
  fin.forEach(s=>segments.push({...s}));
  fin.forEach(s=>segments.push({...s}));

  const elPhase = document.getElementById('phase');
  const elClock = document.getElementById('clock');
  const elLabel = document.getElementById('label');
  const segFill = document.getElementById('segFill');
  const segHint = document.getElementById('segHint');
  const totFill = document.getElementById('totFill');
  const totHint = document.getElementById('totHint');
  const list = document.getElementById('programList');
  const voiceTg = document.getElementById('voiceTg');
  const beepTg = document.getElementById('beepTg');
  const vibrateTg = document.getElementById('vibrateTg');
  const wakeTg = document.getElementById('wakelockTg');
  const nextCueTg = document.getElementById('nextCueTg');
  const detailWarmCoreTg = document.getElementById('detailWarmCoreTg');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const skipBtn = document.getElementById('skipBtn');

  const totalDur = segments.reduce((a,s)=>a+s.dur,0);
  segments.forEach((s,i)=>{
    const li = document.createElement('li');
    const mm = Math.floor(s.dur/60).toString().padStart(2,'0');
    const ss = (s.dur%60).toString().padStart(2,'0');
    li.textContent = `${(i+1).toString().padStart(2,'0')}. ${s.label}${s.sub?` — ${s.sub}`:''}${s.next?` (next: ${s.next})`:''} • ${mm}:${ss}`;
    list.appendChild(li);
  });

  let iSeg = 0;
  let segStart = null;
  let paused = true;
  let elapsedPaused = 0;
  let raf = null;
  let audioCtx = null;
  let wakeLock = null;
  let lastBeepSec = Infinity;

  function fmt(t){
    t = Math.max(0,Math.floor(t));
    const m = Math.floor(t/60).toString().padStart(2,'0');
    const s = (t%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  function speak(text){
    if(!voiceTg.checked) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US'; u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function cueWarmup(t){
    if(!detailWarmCoreTg.checked) return;
    const m = Math.ceil((300 - t)/60);
    if(m===1) speak('Warm-up minute one: hip circles and arm swings.');
    else if(m===2) speak('Minute two: leg swings front to back, and side to side.');
    else if(m===3) speak('Minute three: inchworms or plank shoulder taps.');
    else if(m===4) speak('Minute four: easy jumping jacks.');
    else if(m===5) speak('Minute five: breathe and prep for HIIT.');
  }

  function beep(){
    if(!beepTg.checked) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value = 880;
      g.gain.value=.001; g.gain.exponentialRampToValueAtTime(.00001,(audioCtx.currentTime+0.12));
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.13);
    }catch(e){}
  }

  async function requestWakeLock(){
    if(!wakeTg.checked) return;
    try{
      if('wakeLock' in navigator){
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release',()=>{wakeLock=null});
      }
    }catch(e){}
  }

  function setPhaseUI(s){
    elPhase.textContent = s.type==='work' ? 'Work' : (s.type==='rest' ? 'Rest' : (s.type==='warmup' ? 'Warm-up' : 'Finisher'));
    elLabel.textContent = s.sub ? `${s.label} — ${s.sub}` : (s.next ? `${s.label} — Next: ${s.next}` : s.label);
    segFill.className = 'fill ' + (s.type==='rest'?'rest':'');
  }

  function startSegment(idx){
    iSeg = idx; elapsedPaused = 0; segStart = Date.now(); lastBeepSec = Infinity;
    const s = segments[iSeg];
    setPhaseUI(s);
    elClock.textContent = fmt(remaining());
    segHint.textContent = `Segment ${iSeg+1}/${segments.length}`;
    totHint.textContent = `Total ${Math.round(progressTotal()*100)}%`;
    if(iSeg===0){
      speak('Warm up for five minutes. Easy pace.');
    } else if(s.type==='work'){
      speak(`${s.sub||'Go'}. Thirty seconds. 3 2 1 go.`);
    } else if(s.type==='rest'){
      if(nextCueTg.checked && s.next) speak(`Rest. Fifteen seconds. Next: ${s.next}.`);
      else speak('Rest. Fifteen seconds.');
    } else {
      if(detailWarmCoreTg.checked) speak('Core finisher.');
    }
  }

  function remaining(){
    const s = segments[iSeg];
    if(paused) return s.dur - elapsedPaused;
    const now = Date.now();
    const el = (now - segStart)/1000;
    return Math.max(0, s.dur - el);
  }

  function progressSeg(){
    const s = segments[iSeg];
    return 1 - (remaining()/s.dur);
  }

  function progressTotal(){
    const done = segments.slice(0,iSeg).reduce((a,s)=>a+s.dur,0);
    const cur = segments[iSeg].dur * progressSeg();
    return (done + cur) / totalDur;
  }

  def_lefts = {240:1,180:1,120:1,60:1,1:1}

  function totalRemaining(){
    let r = remaining();
    for(let k=iSeg+1;k<segments.length;k++) r += segments[k].dur;
    return r;
  }

  function tick(){
    const s = segments[iSeg];
    const rem = remaining();
    elClock.textContent = fmt(totalRemaining());
    segFill.style.width = (progressSeg()*100).toFixed(1)+"%";
    totFill.style.width = (progressTotal()*100).toFixed(1)+"%";

    const sec = Math.ceil(rem);
    if(sec<=3 && sec>=1 && sec!==lastBeepSec){
      lastBeepSec = sec; if(beepTg.checked) beep(); if(vibrateTg.checked && navigator.vibrate) navigator.vibrate(40);
    }

    if(s.type==='warmup'){
      const left = Math.round(rem);
      if ([240,180,120,60,1].includes(left)) cueWarmup(left);
    }

    if(rem<=0.05){
      if(iSeg < segments.length-1){
        startSegment(iSeg+1);
      } else {
        cancelAnimationFrame(raf); paused=true; elPhase.textContent='Done!'; elLabel.textContent='Great job — full 25 minutes complete.'; speak('Workout complete. Great job.');
        segFill.style.width='100%'; totFill.style.width='100%';
        if(vibrateTg.checked && navigator.vibrate) navigator.vibrate([120,60,120]);
        return;
      }
    }
    if(!paused) raf = requestAnimationFrame(tick);
  }

  function start(){
    try{ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    requestWakeLock();
    if(paused){
      paused=false;
      if(segStart===null){ startSegment(0); }
      else { segStart = Date.now() - elapsedPaused*1000; }
      raf = requestAnimationFrame(tick);
    }
  }
  function pause(){
    if(!paused){
      paused=true; cancelAnimationFrame(raf);
      const el = segments[iSeg].dur - remaining();
      elapsedPaused = el;
    }
  }
  function reset(){
    paused=true; cancelAnimationFrame(raf);
    iSeg=0; segStart=null; elapsedPaused=0; lastBeepSec=Infinity;
    setPhaseUI({type:'warmup',label:'Ready',sub:'Tap START',dur:1});
    elClock.textContent='25:00';
    segFill.style.width='0%'; segHint.textContent=`Segment 0/${segments.length}`;
    totFill.style.width='0%'; totHint.textContent='Total 0%';
  }
  function skip(){ if(iSeg < segments.length-1){ startSegment(iSeg+1); if(!paused) raf=requestAnimationFrame(tick);} }

  document.getElementById('startBtn').addEventListener('click',start);
  document.getElementById('pauseBtn').addEventListener('click',pause);
  document.getElementById('resetBtn').addEventListener('click',reset);
  document.getElementById('skipBtn').addEventListener('click',skip);

  // Animation loop hook
  let raf = null;
  function loop(){ if(!paused){ tick(); } }
  // but we already schedule via tick -> requestAnimationFrame in start()

  reset();
})();
</script>
</body>
</html>
